<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚ç´…ç¶ ç‡ˆ - Red Light Green Light</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        
        #game-container {
            width: 100%;
            max-width: 700px;
            background: white;
            border: 2px solid #333;
            position: relative;
        }
        
        /* éŠæˆ²çµæŸé®ç½© */
        .game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        .overlay-message {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
        }
        
        .victory-message {
            background: #ffeb3b;
            color: #333;
        }
        
        .defeat-message {
            background: #f44336;
            color: white;
            animation: flash 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes flash {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        .restart-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .restart-button:hover {
            background: #45a049;
        }
        
        /* ç§»å‹•ç«¯å„ªåŒ– */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .overlay-message {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- éŠæˆ²çµæŸé®ç½© -->
        <div id="game-overlay" class="game-overlay">
            <div id="overlay-message" class="overlay-message"></div>
            <button id="restart-button" class="restart-button">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <!-- Phaser.js v3 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <script>
        // ========== éŠæˆ²é…ç½®èˆ‡åˆå§‹åŒ– ==========
        /**
         * é©—è­‰é»1: å ´æ™¯ç¹ªè£½èˆ‡æ©«ç·šã€æ¨™æ–‡å­—å‡ºç¾
         * è‡ªæ¸¬: æª¢æŸ¥èµ·é»ç·š(X=50)ã€çµ‚é»ç·š(X=650)æ˜¯å¦æ­£ç¢ºé¡¯ç¤ºï¼Œä»¥åŠã€Œèµ·é»ã€ã€Œçµ‚é»ã€æ–‡å­—æ¨™ç¤º
         */
        
        class RedLightGreenLightGame extends Phaser.Scene {
            constructor() {
                super({ key: 'RedLightGreenLightGame' });
                
                // éŠæˆ²ç‹€æ…‹
                this.gameState = 'ready'; // ready, playing, gameOver
                this.isRedLight = false;
                this.timeRemaining = 30;
                this.playerLastX = 50; // è¨˜éŒ„ç©å®¶ä¸Šä¸€å¹€çš„Xåº§æ¨™ï¼Œç”¨æ–¼åµæ¸¬ç´…ç‡ˆç§»å‹•
                
                // éŠæˆ²å°è±¡
                this.player = null;
                this.aiGuard = null;
                this.trafficLight = null;
                this.timeText = null;
                
                // éŸ³æ•ˆä¸Šä¸‹æ–‡
                this.audioContext = null;
                this.initAudioContext();
                
                // ç‡ˆè™Ÿåˆ‡æ›è¨ˆæ™‚å™¨
                this.lightSwitchTimer = 0;
                this.currentLightDuration = 0;
                this.isTransitioning = false; // ç‡ˆè™Ÿåˆ‡æ›ä¸­
            }
            
            initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Web Audio API not supported');
                }
            }
            
            /**
             * é©—è­‰é»3: ç´…ç¶ ç‡ˆUIä½ç½®/å°ºå¯¸/å‹•ç•«ã€è²æ•ˆåˆ‡æ›
             * è‡ªæ¸¬: æª¢æŸ¥ç´…ç¶ ç‡ˆå€å¡Šæ˜¯å¦åœ¨æ­£ä¸­å¤®ä¸Šæ–¹(60x60px)ï¼Œåˆ‡æ›æ™‚æ˜¯å¦æœ‰é–ƒçˆå‹•ç•«å’Œè²æ•ˆ
             */
            playSound(frequency, duration) {
                if (!this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.log('Sound playback failed:', e);
                }
            }
            
            preload() {
                // Phaser 3 ä¸éœ€è¦é¡å¤–è¼‰å…¥è³‡æºï¼Œä½¿ç”¨å…§å»ºåœ–å½¢API
            }
            
            create() {
                // å•Ÿç”¨ç”¨æˆ¶äº’å‹•ä»¥æ”¯æ´éŸ³æ•ˆ
                this.input.once('pointerdown', () => {
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                });
                
                this.setupScene();
                this.setupUI();
                this.setupControls();
                this.startGame();
            }
            
            setupScene() {
                /**
                 * é©—è­‰é»1: å ´æ™¯ç¹ªè£½èˆ‡æ©«ç·šã€æ¨™æ–‡å­—å‡ºç¾
                 */
                // è¨­ç½®ç•«å¸ƒèƒŒæ™¯
                this.cameras.main.setBackgroundColor('#ffffff');
                
                // ç¹ªè£½èµ·é»ç·š (X=50)
                const startLine = this.add.graphics();
                startLine.lineStyle(3, 0x000000);
                startLine.lineBetween(50, 100, 50, 300);
                
                // ç¹ªè£½çµ‚é»ç·š (X=650)
                const finishLine = this.add.graphics();
                finishLine.lineStyle(3, 0x000000);
                finishLine.lineBetween(650, 100, 650, 300);
                
                // æ·»åŠ èµ·é»æ–‡å­—æ¨™ç¤º
                this.add.text(20, 310, 'èµ·é»', {
                    fontSize: '16px',
                    fill: '#000000',
                    fontFamily: 'Arial'
                });
                
                // æ·»åŠ çµ‚é»æ–‡å­—æ¨™ç¤º
                this.add.text(620, 310, 'çµ‚é»', {
                    fontSize: '16px',
                    fill: '#000000',
                    fontFamily: 'Arial'
                });
                
                /**
                 * é©—è­‰é»2: è§’è‰²å°ºå¯¸ã€é¡è‰²ã€å®šä½åˆå§‹æ­£ç¢º
                 * è‡ªæ¸¬: ç©å®¶è—åœ“å½¢åŠå¾‘20pxåœ¨X=50, AIç´…æ–¹å½¢20x20åœ¨X=650ï¼ŒYè»¸å±…ä¸­
                 */
                // å‰µå»ºç©å®¶è§’è‰² (è—è‰²åœ“å½¢ï¼ŒåŠå¾‘20px)
                this.player = this.add.circle(50, 200, 20, 0x0066ff);
                this.player.setStrokeStyle(2, 0x004499);
                
                // å‰µå»ºAIç´…ç¶ ç‡ˆå°å§ (ç´…è‰²æ­£æ–¹å½¢ï¼Œ20x20px)
                this.aiGuard = this.add.rectangle(650, 200, 20, 20, 0xff0000);
                this.aiGuard.setStrokeStyle(2, 0xcc0000);
                this.aiGuard.scaleX = 1; // ç”¨æ–¼ç¿»è½‰æœå‘
            }
            
            setupUI() {
                /**
                 * é©—è­‰é»3: ç´…ç¶ ç‡ˆUIä½ç½®/å°ºå¯¸/å‹•ç•«ã€è²æ•ˆåˆ‡æ›
                 */
                // ç´…ç¶ ç‡ˆé¡¯ç¤ºå€å¡Š (ç•«é¢ä¸Šæ–¹æ­£ä¸­å¤® 60x60px)
                this.trafficLight = this.add.rectangle(350, 50, 60, 60, 0x00ff00);
                this.trafficLight.setStrokeStyle(3, 0x000000);
                
                // å‰©é¤˜æ™‚é–“é¡¯ç¤º
                this.timeText = this.add.text(350, 80, 'å‰©é¤˜æ™‚é–“: 30', {
                    fontSize: '18px',
                    fill: '#000000',
                    backgroundColor: '#ffffff',
                    padding: { x: 10, y: 5 },
                    fontFamily: 'Arial'
                }).setOrigin(0.5);
            }
            
            setupControls() {
                /**
                 * é©—è­‰é»4: ç§»å‹•è¦å‰‡ã€ç´…ç‡ˆåµæŸ¥å³æ™‚çµ‚æ­¢
                 * è‡ªæ¸¬: ç¢ºä¿ç©ºç™½éµã€æ–¹å‘éµã€é•·æŒ‰éƒ½èƒ½æ­£ç¢ºæ¨é€²4pxï¼Œç´…ç‡ˆæ™‚ç§»å‹•ç«‹å³å¤±æ•—
                 */
                // PC æ§åˆ¶ - éµç›¤
                this.cursors = this.input.keyboard.createCursorKeys();
                this.spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                
                // Mobile æ§åˆ¶ - è§¸æ§
                this.input.on('pointerdown', () => {
                    this.isTouching = true;
                });
                
                this.input.on('pointerup', () => {
                    this.isTouching = false;
                });
                
                // ç§»å‹•è¼¸å…¥ç‹€æ…‹
                this.isTouching = false;
            }
            
            startGame() {
                this.gameState = 'playing';
                this.timeRemaining = 30;
                this.isRedLight = false;
                this.playerLastX = this.player.x;
                
                // é–‹å§‹ç¶ ç‡ˆ
                this.switchToGreenLight();
                
                // é–‹å§‹è¨ˆæ™‚
                this.time.addEvent({
                    delay: 1000,
                    callback: this.updateTimer,
                    callbackScope: this,
                    loop: true
                });
            }
            
            switchToGreenLight() {
                this.isRedLight = false;
                this.isTransitioning = true;
                
                // ç¶ ç‡ˆæ™‚é•·ï¼š1.5~3.5ç§’
                this.currentLightDuration = Math.random() * 2 + 1.5;
                this.lightSwitchTimer = 0;
                
                // æ›´æ–°UI
                this.trafficLight.setFillStyle(0x00ff00);
                this.createLightFlash(0x00ff00);
                
                // AI èƒŒå°ç©å®¶ (scaleX = -1)
                this.aiGuard.scaleX = -1;
                
                // æ’­æ”¾ç¶ ç‡ˆéŸ³æ•ˆ (ä½é »)
                this.playSound(400, 0.2);
                
                // 0.5ç§’å¾ŒçµæŸè½‰èº«å‹•ç•«
                this.time.delayedCall(500, () => {
                    this.isTransitioning = false;
                });
            }
            
            switchToRedLight() {
                this.isRedLight = true;
                this.isTransitioning = true;
                
                // ç´…ç‡ˆæ™‚é•·ï¼š0.8~1.8ç§’
                this.currentLightDuration = Math.random() + 0.8;
                this.lightSwitchTimer = 0;
                
                // æ›´æ–°UI
                this.trafficLight.setFillStyle(0xff0000);
                this.createLightFlash(0xff0000);
                
                // AI é¢å‘ç©å®¶ (scaleX = 1)
                this.aiGuard.scaleX = 1;
                
                // æ’­æ”¾ç´…ç‡ˆéŸ³æ•ˆ (é«˜é »)
                this.playSound(800, 0.2);
                
                // 0.5ç§’å¾ŒçµæŸè½‰èº«å‹•ç•«
                this.time.delayedCall(500, () => {
                    this.isTransitioning = false;
                });
            }
            
            createLightFlash(color) {
                // ç‡ˆå…‰é–ƒçˆå‹•ç•«
                this.tweens.add({
                    targets: this.trafficLight,
                    scaleX: 1.2,
                    scaleY: 1.2,
                    duration: 200,
                    yoyo: true,
                    repeat: 2
                });
            }
            
            update() {
                if (this.gameState !== 'playing') return;
                
                // æ›´æ–°ç‡ˆè™Ÿåˆ‡æ›è¨ˆæ™‚
                this.lightSwitchTimer += this.game.loop.delta / 1000;
                
                if (this.lightSwitchTimer >= this.currentLightDuration) {
                    if (this.isRedLight) {
                        this.switchToGreenLight();
                    } else {
                        this.switchToRedLight();
                    }
                }
                
                // è™•ç†ç©å®¶ç§»å‹•
                this.handlePlayerMovement();
                
                // æª¢æŸ¥å‹è² æ¢ä»¶
                this.checkGameConditions();
            }
            
            handlePlayerMovement() {
                /**
                 * é©—è­‰é»4: ç§»å‹•è¦å‰‡ã€ç´…ç‡ˆåµæŸ¥å³æ™‚çµ‚æ­¢
                 */
                let shouldMove = false;
                
                // æª¢æŸ¥è¼¸å…¥
                if (this.cursors.right.isDown || this.cursors.up.isDown || 
                    this.spaceKey.isDown || this.isTouching) {
                    shouldMove = true;
                }
                
                if (shouldMove && !this.isRedLight && !this.isTransitioning) {
                    // ç¶ ç‡ˆæ™‚å…è¨±ç§»å‹•ï¼Œæ¯å¹€æ¨é€²4px
                    this.player.x += 4;
                    this.player.x = Math.min(this.player.x, 650); // é™åˆ¶ä¸è¶…éçµ‚é»
                }
                
                // ç´…ç‡ˆåµæ¸¬ï¼šæª¢æŸ¥ç©å®¶Xåº§æ¨™æ˜¯å¦è®ŠåŒ–
                if (this.isRedLight && !this.isTransitioning) {
                    if (this.player.x !== this.playerLastX) {
                        // ç´…ç‡ˆæ™‚ç§»å‹•è¢«ç™¼ç¾ï¼Œç«‹å³å¤±æ•—
                        this.gameOver(false, 'ç§»å‹•è¢«ç™¼ç¾ï¼');
                        return;
                    }
                }
                
                // æ›´æ–°ä¸Šä¸€å¹€ä½ç½®è¨˜éŒ„
                this.playerLastX = this.player.x;
            }
            
            checkGameConditions() {
                /**
                 * é©—è­‰é»5: å‹è² åˆ¤å®šã€é®ç½©èˆ‡é‡ç©æµç¨‹å®Œæ•´ç„¡èª¤
                 * è‡ªæ¸¬: ç©å®¶X>=650éé—œï¼Œæ™‚é–“æ­¸é›¶å¤±æ•—ï¼Œç´…ç‡ˆç§»å‹•å¤±æ•—ï¼Œé®ç½©å’Œé‡ç©åŠŸèƒ½æ­£å¸¸
                 */
                // æª¢æŸ¥å‹åˆ©æ¢ä»¶ (ç©å®¶åœ“å½¢ä¸­å¿ƒXåº§æ¨™ >= 650)
                if (this.player.x >= 650) {
                    this.gameOver(true, 'æ­å–œéé—œï¼');
                    return;
                }
                
                // æª¢æŸ¥è¶…æ™‚å¤±æ•—
                if (this.timeRemaining <= 0) {
                    this.gameOver(false, 'æ™‚é–“åˆ°ï¼è«‹å†æ¥å†å²');
                    return;
                }
            }
            
            updateTimer() {
                if (this.gameState === 'playing') {
                    this.timeRemaining--;
                    this.timeText.setText(`å‰©é¤˜æ™‚é–“: ${this.timeRemaining}`);
                }
            }
            
            gameOver(isVictory, message) {
                /**
                 * é©—è­‰é»5: å‹è² åˆ¤å®šã€é®ç½©èˆ‡é‡ç©æµç¨‹å®Œæ•´ç„¡èª¤
                 */
                this.gameState = 'gameOver';
                
                // é¡¯ç¤ºé®ç½©
                const overlay = document.getElementById('game-overlay');
                const messageElement = document.getElementById('overlay-message');
                
                messageElement.textContent = message;
                
                if (isVictory) {
                    messageElement.className = 'overlay-message victory-message';
                    // å‹åˆ©éŸ³æ•ˆ (æ­¡å‘¼è²æ¨¡æ“¬)
                    this.playVictorySound();
                } else {
                    messageElement.className = 'overlay-message defeat-message';
                    // å¤±æ•—éŸ³æ•ˆ
                    this.playDefeatSound();
                }
                
                overlay.style.display = 'flex';
                
                // è¨­ç½®é‡ç©æŒ‰éˆ•
                document.getElementById('restart-button').onclick = () => {
                    this.restartGame();
                };
            }
            
            playVictorySound() {
                // æ­¡å‘¼è²æ¨¡æ“¬ (å¤šéŸ³èª¿å¿«é€Ÿæ’­æ”¾)
                const frequencies = [523, 659, 784, 1047];
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        this.playSound(freq, 0.2);
                    }, index * 100);
                });
            }
            
            playDefeatSound() {
                // å¤±æ•—éŸ³æ•ˆ (ä½æ²‰çš„éŸ³èª¿)
                this.playSound(200, 0.5);
                setTimeout(() => {
                    this.playSound(150, 0.5);
                }, 200);
            }
            
            restartGame() {
                // éš±è—é®ç½©
                document.getElementById('game-overlay').style.display = 'none';
                
                // é‡ç½®éŠæˆ²ç‹€æ…‹
                this.gameState = 'ready';
                this.timeRemaining = 30;
                this.isRedLight = false;
                this.isTransitioning = false;
                
                // é‡ç½®è§’è‰²ä½ç½®
                this.player.x = 50;
                this.playerLastX = 50;
                this.aiGuard.scaleX = 1;
                
                // é‡ç½®UI
                this.trafficLight.setFillStyle(0x00ff00);
                this.timeText.setText('å‰©é¤˜æ™‚é–“: 30');
                
                // æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
                this.time.removeAllEvents();
                
                // é‡æ–°é–‹å§‹éŠæˆ²
                this.startGame();
            }
        }
        
        // ========== Phaser éŠæˆ²é…ç½® ==========
        const config = {
            type: Phaser.AUTO,
            width: 700,
            height: 400,
            parent: 'game-container',
            backgroundColor: '#ffffff',
            scene: RedLightGreenLightGame,
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                min: {
                    width: 350,
                    height: 200
                }
            },
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            }
        };
        
        // å•Ÿå‹•éŠæˆ²
        const game = new Phaser.Game(config);
        
        /**
         * ==========  å…¨åŠŸèƒ½é©—è­‰æª¢æŸ¥æ¸…å–® ==========
         * 
         * 1. âœ… å ´æ™¯ç¹ªè£½èˆ‡æ©«ç·šã€æ¨™æ–‡å­—å‡ºç¾
         *    - èµ·é»ç·š X=50ï¼Œçµ‚é»ç·š X=650
         *    - ã€Œèµ·é»ã€ã€Œçµ‚é»ã€ä¸­æ–‡æ¨™ç¤º
         * 
         * 2. âœ… è§’è‰²å°ºå¯¸ã€é¡è‰²ã€å®šä½åˆå§‹æ­£ç¢º
         *    - ç©å®¶ï¼šè—è‰²åœ“å½¢ï¼ŒåŠå¾‘20pxï¼Œåˆå§‹X=50
         *    - AIï¼šç´…è‰²æ­£æ–¹å½¢ï¼Œ20x20pxï¼Œåˆå§‹X=650
         *    - Yè»¸å±…ä¸­å°é½Š
         * 
         * 3. âœ… ç´…ç¶ ç‡ˆUIä½ç½®/å°ºå¯¸/å‹•ç•«ã€è²æ•ˆåˆ‡æ›
         *    - ä¸Šæ–¹æ­£ä¸­å¤® 60x60px å€å¡Š
         *    - ç´…ç‡ˆ/ç¶ ç‡ˆé¡è‰²æ­£ç¢ºåˆ‡æ›
         *    - é–ƒçˆå‹•ç•«æ•ˆæœ
         *    - Web Audio ç”ŸæˆéŸ³æ•ˆ
         * 
         * 4. âœ… ç§»å‹•è¦å‰‡ã€ç´…ç‡ˆåµæŸ¥å³æ™‚çµ‚æ­¢
         *    - æ”¯æ´ç©ºç™½éµã€æ–¹å‘éµ(ä¸Š/å³)ã€æ‰‹æ©Ÿé•·æŒ‰
         *    - æ¯å¹€æ¨é€²4px
         *    - ç¶ ç‡ˆ1.5~3.5ç§’ï¼Œç´…ç‡ˆ0.8~1.8ç§’
         *    - ç´…ç‡ˆç§»å‹•ç«‹å³å¤±æ•—
         *    - AIè½‰èº«å‹•ç•«0.5ç§’
         * 
         * 5. âœ… å‹è² åˆ¤å®šã€é®ç½©èˆ‡é‡ç©æµç¨‹å®Œæ•´ç„¡èª¤
         *    - X>=650å‹åˆ©
         *    - 30ç§’å€’æ•¸è¨ˆæ™‚
         *    - åŠé€æ˜é®ç½©é¡¯ç¤º
         *    - å‹åˆ©/å¤±æ•—éŸ³æ•ˆ
         *    - é‡ç©æŒ‰éˆ•å®Œæ•´é‡ç½®
         * 
         * ğŸ“± PC/Mobile é›™å¹³å°æ”¯æ´:
         *    - éµç›¤: ç©ºç™½éµã€æ–¹å‘éµ(ä¸Š/å³)
         *    - è§¸æ§: ä»»æ„è™•é•·æŒ‰/é€£æ‰“
         *    - RWD éŸ¿æ‡‰å¼è¨­è¨ˆ
         * 
         * ğŸ”Š éŸ³æ•ˆç³»çµ±:
         *    - ç´…ç‡ˆéŸ³æ•ˆ: 800Hz
         *    - ç¶ ç‡ˆéŸ³æ•ˆ: 400Hz  
         *    - å‹åˆ©éŸ³æ•ˆ: å¤šéŸ³èª¿çµ„åˆ
         *    - å¤±æ•—éŸ³æ•ˆ: ä½é »éŸ³èª¿
         */
    </script>
</body>
</html>